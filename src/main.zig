// {
//   "master": {
//     "version": "0.10.0-dev.4476+0f0076666",
//     "date": "2022-10-21",
//     "docs": "https://ziglang.org/documentation/master/",
//     "stdDocs": "https://ziglang.org/documentation/master/std/",
//     "src": {
//       "tarball": "https://ziglang.org/builds/zig-0.10.0-dev.4476+0f0076666.tar.xz",
//       "shasum": "978930e7d1a2c90f40cd0a1b5be00a5de7d9d23a166e40a0f0845e72e693453f",
//       "size": "15936064"
//     },
//     "x86_64-freebsd": {
//       "tarball": "https://ziglang.org/builds/zig-freebsd-x86_64-0.10.0-dev.4476+0f0076666.tar.xz",
//       "shasum": "1e970d2f992e92b11328b9dc47362f3a25c3df84f0a6bbb9499fa70a22592a1e",
//       "size": "41072896"
//     },
//     "x86_64-macos": {
//       "tarball": "https://ziglang.org/builds/zig-macos-x86_64-0.10.0-dev.4476+0f0076666.tar.xz",
//       "shasum": "acaab325984b37d60c2b780654ae1537992c760065796b65f7dcce1daa6c4c7f",
//       "size": "44213756"
//     },
//     "aarch64-macos": {
//       "tarball": "https://ziglang.org/builds/zig-macos-aarch64-0.10.0-dev.4476+0f0076666.tar.xz",
//       "shasum": "6c5d7178179366d203b4dc9f10f01e9d74ec0617c878d0a8d6a111a9173c0fd8",
//       "size": "41019624"
//     },
//     "x86_64-windows": {
//       "tarball": "https://ziglang.org/builds/zig-windows-x86_64-0.10.0-dev.4476+0f0076666.zip",
//       "shasum": "70a0381424a04346902ba43125ef5b10ef752bd161d58b34c72ee34e0958020b",
//       "size": "69323752"
//     },
//     "x86_64-linux": {
//       "tarball": "https://ziglang.org/builds/zig-linux-x86_64-0.10.0-dev.4476+0f0076666.tar.xz",
//       "shasum": "7e8a55c36db1d2d30a57feac7b104c0a7c7585bd69847352baf600f087eecc20",
//       "size": "44296568"
//     },
//     "aarch64-linux": {
//       "tarball": "https://ziglang.org/builds/zig-linux-aarch64-0.10.0-dev.4476+0f0076666.tar.xz",
//       "shasum": "95eb640718c1fa38171c46cc3bf21ad82a84663aae28d495b1717c6d1d0f454e",
//       "size": "37461248"
//     }
//   },
//   "0.9.1": {
//     "date": "2022-02-14",
//     "docs": "https://ziglang.org/documentation/0.9.1/",
//     "stdDocs": "https://ziglang.org/documentation/0.9.1/std/",
//     "notes": "https://ziglang.org/download/0.9.1/release-notes.html",
//     "src": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-0.9.1.tar.xz",
//       "shasum": "38cf4e84481f5facc766ba72783e7462e08d6d29a5d47e3b75c8ee3142485210",
//       "size": "13940828"
//     },
//     "bootstrap": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-bootstrap-0.9.1.tar.xz",
//       "shasum": "0a8e221c71860d8975c15662b3ed3bd863e81c4fe383455a596e5e0e490d6109",
//       "size": "42488812"
//     },
//     "x86_64-freebsd": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-freebsd-x86_64-0.9.1.tar.xz",
//       "shasum": "4e06009bd3ede34b72757eec1b5b291b30aa0d5046dadd16ecb6b34a02411254",
//       "size": "39028848"
//     },
//     "aarch64-linux": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-linux-aarch64-0.9.1.tar.xz",
//       "shasum": "5d99a39cded1870a3fa95d4de4ce68ac2610cca440336cfd252ffdddc2b90e66",
//       "size": "37034860"
//     },
//     "armv7a-linux": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-linux-armv7a-0.9.1.tar.xz",
//       "shasum": "6de64456cb4757a555816611ea697f86fba7681d8da3e1863fa726a417de49be",
//       "size": "37974652"
//     },
//     "i386-linux": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-linux-i386-0.9.1.tar.xz",
//       "shasum": "e776844fecd2e62fc40d94718891057a1dbca1816ff6013369e9a38c874374ca",
//       "size": "44969172"
//     },
//     "riscv64-linux": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-linux-riscv64-0.9.1.tar.xz",
//       "shasum": "208dea53662c2c52777bd9e3076115d2126a4f71aed7f2ff3b8fe224dc3881aa",
//       "size": "39390868"
//     },
//     "x86_64-linux": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-linux-x86_64-0.9.1.tar.xz",
//       "shasum": "be8da632c1d3273f766b69244d80669fe4f5e27798654681d77c992f17c237d7",
//       "size": "41011464"
//     },
//     "aarch64-macos": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-macos-aarch64-0.9.1.tar.xz",
//       "shasum": "8c473082b4f0f819f1da05de2dbd0c1e891dff7d85d2c12b6ee876887d438287",
//       "size": "38995640"
//     },
//     "x86_64-macos": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-macos-x86_64-0.9.1.tar.xz",
//       "shasum": "2d94984972d67292b55c1eb1c00de46580e9916575d083003546e9a01166754c",
//       "size": "43713044"
//     },
//     "i386-windows": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-windows-i386-0.9.1.zip",
//       "shasum": "74a640ed459914b96bcc572183a8db687bed0af08c30d2ea2f8eba03ae930f69",
//       "size": "67929868"
//     },
//     "x86_64-windows": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-windows-x86_64-0.9.1.zip",
//       "shasum": "443da53387d6ae8ba6bac4b3b90e9fef4ecbe545e1c5fa3a89485c36f5c0e3a2",
//       "size": "65047697"
//     },
//     "aarch64-windows": {
//       "tarball": "https://ziglang.org/download/0.9.1/zig-windows-aarch64-0.9.1.zip",
//       "shasum": "621bf95f54dc3ff71466c5faae67479419951d7489e40e87fd26d195825fb842",
//       "size": "61478151"
//     }
//   },
// }

const std = @import("std");
const net = std.net;
const mem = std.mem;
const fs = std.fs;
const io = std.io;
const os = std.os;
const win = std.os.windows;
const ws2_32 = std.os.windows.ws2_32;

pub fn main() !void {
    // get ./temp directory
    // const temp_dir = try fs.cwd().openDir("temp", .{ .iterate = true });
    // defer temp_dir.close();
    // // create a new file in the temp directory
    // const file = try temp_dir.createFile("data.tar.xz", .{});
    // start WSA on windows version 2.2
    const res: ws2_32.WSADATA = try win.WSAStartup(2, 2);
    const max_sockets: u16 = res.iMaxSockets;
    defer win.WSACleanup() catch unreachable;
    std.log.info("max sockets: {}", .{max_sockets});

    // query https://ziglang.org/download/index.json
    const alloc = std.heap.page_allocator;
    const client: std.net.Stream = try net.tcpConnectToHost(alloc, "ziglang.org", 80);

    // send request
    // content type json
    const request =
        \\GET /download/index.json HTTP/1.1
        \\User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/107.0.0.0 Safari/537.36
        \\Host: ziglang.org
        \\Accept-Language: en-US
        \\Accept-Encoding: gzip, deflate
        \\Content-Type: application/json
        \\Connection: keep-alive
        \\Accept: */*
    ;
    comptime {
        // check if it contains a \r
        var i: usize = 0;
        while (i < request.len) : (i += 1) {
            if (request[i] == '\r') {
                @panic("request contains \\r");
            }
        }
    }
    std.log.info("===== request =====\n{s}\n===== request =====", .{request});

    try client.writer().writeAll(request);

    // allocate 128kb buffer
    var buf: [128 * 1024]u8 = undefined;
    // write all data to buffer
    var total: usize = 0;
    while (true) {
        const bytes_read = try client.reader().read(buf[total..]);
        if (bytes_read == 0) break;
        total += bytes_read;
    }
    std.log.info("total bytes read: {}", .{total});
    std.log.info("{s}", .{buf[0..total]});
    var parser = std.json.Parser.init(alloc, false);
    const tree: std.json.ValueTree = try parser.parse(buf[0..total]);

    const root = tree.root.Object;
    var versionsIter = root.iterator();
    while (versionsIter.next()) |entry| {
        const version = entry.key_ptr;
        const targets = entry.value_ptr.Object;
        var targetsIter = targets.iterator();
        while (targetsIter.next()) |target| {
            const target_name = target.key_ptr;
            const target_data = target.value_ptr.Object;
            const tarball = target_data.get("tarball").?.String;
            const shasum = target_data.get("shasum").?.String;
            const size = target_data.get("size").?.String;
            std.debug.print("version: {s}, target: {s}, tarball: {s}, shasum: {s}, size: {s}\n", .{ version, target_name, tarball, shasum, size });
        }
    }
}
